# Fallout 76 Packet Parser

This Python script is designed to parse and analyze network packet logs generated by Fallout 76 (specifically tested with logs like `Client_PLg.0.log`). It reconstructs fragmented UDP packets, decodes various packet types, and dives into the structure of game state update packets, including their component data with Zero Run-Length (ZRL) decompression.

## Overview

Fallout 76 uses a complex network protocol to synchronize game state between the client and server. This parser aims to:

1.  Read packet data captured in log files (JSON format with hex-encoded packet payloads).
2.  Reassemble fragmented UDP packets based on sequence numbers, total fragments, and fragment numbers.
3.  Identify and parse different packet types (Ping/Pong, Main game state).
4.  Decode the structure of the main game state packets (Type 130), including headers, acknowledgment information, delta/base sequencing, and component data blocks.
5.  Parse the individual "Components" within the game state packets, interpreting their headers to determine fields like Entity ID, Component ID, Resource ID, and data size.
6.  Decompress component data using a Zero Run-Length (ZRL) algorithm implemented in the script.
7.  Provide detailed logging for debugging and analysis.
8.  Output the raw, reconstructed packets to a binary file for further inspection.

## Features

*   **Log Parsing:** Reads JSON log entries containing packet direction (`net.packet.recv`/`net.packet.send`) and hex data.
*   **Packet Reconstruction:** Reassembles fragmented UDP packets (Type 130) across multiple log entries, handling sequence number rollovers.
*   **Packet Type Handling:**
    *   Parses basic packet structure (Client ID, Type, Sequence).
    *   Decodes Ping/Pong related packets (Type 128, 129).
    *   Decodes main game state packets (Type 130).
*   **Main Packet Decoding (Type 130):**
    *   Parses frame, flags, sequenced/unsequenced message sizes (Rmsg - *Note: Rmsg content expansion is currently incomplete*).
    *   Extracts ACK information (`last_ack`, `ack_bits`).
    *   Parses delta update fields (`delta`, `base`).
    *   Identifies component block size (`compressed_body`, `uncompressed_body`, `component_count`).
    *   Extracts the raw `component_data` block.
*   **Component Parsing (`Snapshot`):**
    *   Parses the `component_data` blob as a stream of Components.
    *   Interprets the component header byte to determine:
        *   Action (UpdateFromDefault, UpdateFromPrevious, DeleteComponent, DeleteEntity)
        *   Field lengths (EntityID, ComponentID, ResourceID, ComponentSize)
        *   Compression status (ZRL or uncompressed)
    *   Extracts EntityID, ComponentID, ResourceID, ComponentSize, and the component payload buffer.
*   **Decompression:** Implements Zero Run-Length (ZRL) decompression for component data flagged as compressed.
*   **Logging:** Extensive debug logging to trace the parsing process.
*   **Output:** Saves the reconstructed raw packet payloads to `reconstructed_packets.bin`.
*   **Testing:** Includes a basic test function for the `Snapshot` component parsing logic.

## Requirements

*   Python 3.6+ (due to f-strings, type hints)
*   Standard Python libraries (`json`, `datetime`, `collections`, `struct`, `logging`, `io`, `typing`) - no external dependencies required.

## Installation

1.  Clone the repository:
    ```bash
    git clone https://github.com/yourusername/fallout76-packet-parser.git
    cd fallout76-packet-parser
    ```
2.  Place your Fallout 76 packet log file (e.g., `Client_PLg.0.log`) in the same directory as `packet_parse.py`.

## Usage

1.  **Ensure Log File Exists:** Make sure the log file specified in the `main()` function (default: `"Client_PLg.0.log"`) is present in the script's directory.
2.  **Run the Script:**
    ```bash
    python packet_parse.py
    ```
3.  **Output:**
    *   **Console:** Detailed logs will be printed to the console. The level of detail depends on the `logging.basicConfig` level (set to `DEBUG` by default for maximum information). This includes parsed packet headers, component details, warnings about missing fragments, and potential errors.
    *   **`reconstructed_packets.bin`:** A binary file containing the raw payloads of the successfully reconstructed packets (Types 128, 129, 130) in the order they were processed.

4.  **Run Tests:** To run the built-in test for component parsing:
    ```bash
    python packet_parse.py test
    ```

## Code Structure

*   **`packet_parse.py`:** The main script.
    *   **`Component` class:** Represents a single game state component within a packet.
    *   **`ZeroRunLengthCompression` class:** Handles ZRL decompression.
    *   **`Snapshot` class:** Parses the `component_data` block from Type 130 packets into a list of `Component` objects.
    *   **`parse_packet_udp`:** Parses the initial UDP header/fragment info from a log entry.
    *   **`parse_packet_ping`:** Parses the payload of Type 128/129 packets.
    *   **`parse_packet_main`:** Parses the payload of Type 130 packets (excluding Rmsg expansion).
    *   **`lzw_decompress`:** (Currently unused in main flow) An LZW decompression function.
    *   **`reconstruct_packets`:** Orchestrates the reassembly of fragmented packets from log entries.
    *   **`process_packet_components`:** Helper to process components using the `Snapshot` class (called within `main`).
    *   **`test_snapshot_parsing`:** Contains test code for the `Snapshot` parser.
    *   **`main`:** Entry point, reads the log file, calls reconstruction and parsing, and writes the output file.

## Limitations & TODOs

*   **Rmsg Data:** The script identifies the presence and size of sequenced (`rmsg_data`) and unsequenced (`unseq_rmsg_data`) messages within Type 130 packets, but **it does not currently parse the *content* of these Rmsgs**. Further research is needed to decode their structure.
*   **LZW Decompression:** An `lzw_decompress` function exists but is not currently used in the packet processing pipeline. It's unclear if or where LZW is used in the protocol parts handled by this script.
*   **Component Payload Analysis:** The script successfully extracts the `componentBuffer` for each component, but it does not interpret the *meaning* of the data within these buffers. This would require deeper reverse engineering specific to each `ComponentId`.
*   **Error Handling:** While basic error handling and logging exist, edge cases in malformed logs or unexpected packet structures might lead to script errors or incomplete parsing.
*   **Protocol Accuracy:** This parser is based on observed patterns in log files. The Fallout 76 network protocol is proprietary and subject to change with game updates, which could break this parser.

## Contributing

Contributions are welcome! If you have insights into the packet structures (especially Rmsgs or component payloads), find bugs, or want to improve the code, please feel free to:

1.  Open an Issue to discuss the change or report a bug.
2.  Fork the repository, make your changes, and submit a Pull Request.

## Disclaimer

This tool is provided for educational and research purposes only. It is based on reverse engineering efforts and is not affiliated with or endorsed by Bethesda Game Studios or ZeniMax Media. Using this tool to interact with live game servers may violate the game's Terms of Service.
